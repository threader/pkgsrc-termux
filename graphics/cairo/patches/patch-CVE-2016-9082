$NetBSD: patch-CVE-2016-9082,v 1.1 2017/09/28 00:57:25 spz Exp $

from https://bugs.freedesktop.org/attachment.cgi?id=127421

--- boilerplate/cairo-boilerplate.c.orig	2017-06-15 22:13:55.000000000 +0000
+++ boilerplate/cairo-boilerplate.c
@@ -42,6 +42,7 @@
 #undef CAIRO_VERSION_H
 #include "../cairo-version.h"
 
+#include <stddef.h>
 #include <stdlib.h>
 #include <ctype.h>
 #include <assert.h>
@@ -976,7 +977,8 @@ cairo_surface_t *
 cairo_boilerplate_image_surface_create_from_ppm_stream (FILE *file)
 {
     char format;
-    int width, height, stride;
+    int width, height;
+    ptrdiff_t stride;
     int x, y;
     unsigned char *data;
     cairo_surface_t *image = NULL;

--- src/cairo-image-compositor.c.orig	2017-06-15 22:13:55.000000000 +0000
+++ src/cairo-image-compositor.c
@@ -1575,7 +1575,7 @@ typedef struct _cairo_image_span_rendere
     pixman_image_t *src, *mask;
     union {
 	struct fill {
-	    int stride;
+	    ptrdiff_t stride;
 	    uint8_t *data;
 	    uint32_t pixel;
 	} fill;
@@ -1594,7 +1594,7 @@ typedef struct _cairo_image_span_rendere
 	struct finish {
 	    cairo_rectangle_int_t extents;
 	    int src_x, src_y;
-	    int stride;
+	    ptrdiff_t stride;
 	    uint8_t *data;
 	} mask;
     } u;

--- src/cairo-image-surface-private.h.orig	2017-06-09 06:46:49.000000000 +0000
+++ src/cairo-image-surface-private.h
@@ -71,7 +71,7 @@ struct _cairo_image_surface {
 
     int width;
     int height;
-    int stride;
+    ptrdiff_t stride;
     int depth;
 
     unsigned owns_data : 1;

--- src/cairo-mesh-pattern-rasterizer.c.orig	2017-06-15 22:13:55.000000000 +0000
+++ src/cairo-mesh-pattern-rasterizer.c
@@ -470,7 +470,7 @@ draw_pixel (unsigned char *data, int wid
 	tg += tg >> 16;
 	tb += tb >> 16;
 
-	*((uint32_t*) (data + y*stride + 4*x)) = ((ta << 16) & 0xff000000) |
+	*((uint32_t*) (data + y*(ptrdiff_t)stride + 4*x)) = ((ta << 16) & 0xff000000) |
 	    ((tr >> 8) & 0xff0000) | ((tg >> 16) & 0xff00) | (tb >> 24);
     }
 }

--- src/cairo-png.c.orig	2017-06-15 21:44:32.000000000 +0000
+++ src/cairo-png.c
@@ -671,7 +671,7 @@ read_png (struct png_read_closure_t *png
     }
 
     for (i = 0; i < png_height; i++)
-        row_pointers[i] = &data[i * stride];
+        row_pointers[i] = &data[i * (ptrdiff_t)stride];
 
     png_read_image (png, row_pointers);
     png_read_end (png, info);

--- src/cairo-script-surface.c.orig	2017-06-15 22:13:55.000000000 +0000
+++ src/cairo-script-surface.c
@@ -1201,7 +1201,8 @@ static cairo_status_t
 _write_image_surface (cairo_output_stream_t *output,
 		      const cairo_image_surface_t *image)
 {
-    int stride, row, width;
+    int row, width;
+    ptrdiff_t stride;
     uint8_t row_stack[CAIRO_STACK_BUFFER_SIZE];
     uint8_t *rowdata;
     uint8_t *data;
